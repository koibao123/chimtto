<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Arena of Valor Map Sharing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.9.2/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.9.2/mapbox-gl.css' rel='stylesheet' />
    <style>
        html {
            height: 100%;
        }
        body {
            -webkit-tap-highlight-color: transparent;
        }
        #map { 
            width: 100%; 
            height: 70vh; 
            border-radius: 12px;
        }
        #screenShare {
            width: 100%;
            height: 250px;
            background-color: #1e293b;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            -webkit-overflow-scrolling: touch;
        }
        #screenShare video {
            max-width: 100%;
            max-height: 100%;
            border-radius: 8px;
        }
        .marker {
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzMiAzMiI+PGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iMTQiIGZpbGw9IiMzYjgyZjYiLz48L3N2Zz4=');
            background-size: cover;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
        }
        @media (max-width: 768px) {
            #map {
                height: 60vh;
            }
        }
    </style>
</head>
<body class="bg-slate-900 text-white p-4">
    <div id="appInstructions" class="bg-yellow-900 text-yellow-200 p-2 text-center hidden">
        Ứng dụng đang chạy ở chế độ di động. Để chia sẻ màn hình:
        <ol class="list-decimal text-left inline-block">
            <li>Mở bằng trình duyệt Chrome</li>  
            <li>Bật chế độ Desktop Site</li>
            <li>Thử lại chức năng chia sẻ</li>
        </ol>
    </div>
    <div class="container mx-auto max-w-4xl px-2">
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-center text-sky-500">Arena of Valor Map Sharing</h1>
            <p class="text-center text-slate-400">Chia sẻ bản đồ và màn hình trận đấu trực tiếp</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">
            <div class="bg-slate-800 p-4 rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold mb-4 text-center">Bản đồ trận đấu</h2>
                <div id="map" class="shadow-md"></div>
                <div class="mt-4 flex justify-center space-x-4">
                    <button id="shareScreenBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition w-full md:w-auto mr-2">
                        Chia sẻ màn hình
                    </button>
                    <button id="shareAudioBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition w-full md:w-auto">
                        Chia sẻ thoại
                    </button>
                    <button id="stopShareBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition" disabled>
                        Dừng chia sẻ
                    </button>
                </div>
            </div>

            <div class="bg-slate-800 p-4 rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold mb-4 text-center">Người chơi đang chia sẻ</h2>
                <div id="activeUsers" class="mb-4">
                    <div class="bg-slate-700 p-3 rounded-lg mb-2">
                        <p class="text-sm text-slate-400">Đang tải danh sách người chơi...</p>
                    </div>
                </div>
                
                <div id="screenShareContainer">
                    <h3 class="text-lg mb-2">Xem màn hình của đồng đội:</h3>
                    <div id="screenShare">
                        <p class="text-slate-400">Chưa có ai đang chia sẻ màn hình</p>
                    </div>
                    <div class="mt-3">
                        <input type="text" id="roomId" placeholder="Nhập mã phòng từ người chia sẻ" class="w-full p-2 rounded bg-slate-700 text-white mb-2">
                        <button id="connectBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition w-full">
                            Kết nối
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Mobile detection
        if (/Android|iPhone|iPad/i.test(navigator.userAgent)) {
            document.getElementById('appInstructions').classList.remove('hidden');
        }
        
        // Khởi tạo bản đồ
        mapboxgl.accessToken = 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw';
        
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/dark-v10',
            center: [107.1, 10.5],
            zoom: 6,
            pitch: 45
        });

        // Thêm các điểm đánh dấu trên bản đồ
        map.on('load', () => {
            // Thêm nguồn dữ liệu và lớp cho bản đồ
            map.addSource('map', {
                type: 'geojson',
                data: {
                    type: 'FeatureCollection',
                    features: []
                }
            });

            // Lớp vẽ các điểm
            map.addLayer({
                id: 'points',
                type: 'circle',
                source: 'map',
                paint: {
                    'circle-radius': 10,
                    'circle-color': '#3b82f6',
                    'circle-stroke-width': 2,
                    'circle-stroke-color': '#ffffff'
                }
            });

            // Đánh dấu các vị trí quan trọng trong Liên Quân
            const importantLocations = [
                { name: "Trụ chính", coordinates: [107.0, 10.55] },
                { name: "Rừng quái", coordinates: [107.05, 10.48] },
                { name: "Đường giữa", coordinates: [107.1, 10.5] },
                { name: "Đường trên", coordinates: [107.15, 10.53] },
                { name: "Đường dưới", coordinates: [107.05, 10.47] }
            ];

            // Tạo popup cho từng điểm
            importantLocations.forEach(location => {
                const el = document.createElement('div');
                el.className = 'marker';
                
                new mapboxgl.Marker(el)
                    .setLngLat(location.coordinates)
                    .setPopup(new mapboxgl.Popup({ offset: 25 })
                    .setHTML(`<h3 class="font-bold">${location.name}</h3>`))
                    .addTo(map);
            });
        });

        // Xử lý chia sẻ màn hình
        const shareBtn = document.getElementById('shareBtn');
        const stopShareBtn = document.getElementById('stopShareBtn');
        const connectBtn = document.getElementById('connectBtn');
        const screenShare = document.getElementById('screenShare');
        const roomId = document.getElementById('roomId');
        const activeUsers = document.getElementById('activeUsers');

        let localStream = null;
        let peerConnection = null;
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' }
            ],
            iceTransportPolicy: 'relay',
            bundlePolicy: 'max-bundle'
        };

        // Mô phỏng danh sách người chơi đang chia sẻ
        function updateActiveUsers() {
            activeUsers.innerHTML = `
                <div class="bg-slate-700 p-3 rounded-lg mb-2 cursor-pointer hover:bg-slate-600" onclick="connectToStream('58372')">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-blue-500 rounded-full mr-3"></div>
                        <div>
                            <p class="font-medium">Player1</p>
                            <p class="text-xs text-slate-400">Đang chia sẻ màn hình</p>
                        </div>
                        <div class="ml-auto bg-green-500 text-xs px-2 py-1 rounded">Online</div>
                    </div>
                </div>
                <div class="bg-slate-700 p-3 rounded-lg mb-2 cursor-pointer hover:bg-slate-600" onclick="connectToStream('92645')">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-purple-500 rounded-full mr-3"></div>
                        <div>
                            <p class="font-medium">Player2</p>
                            <p class="text-xs text-slate-400">Đang chia sẻ bản đồ</p>
                        </div>
                        <div class="ml-auto bg-green-500 text-xs px-2 py-1 rounded">Online</div>
                    </div>
                </div>
            `;
        }

        // Handle connecting to another peer
        window.connectToStream = async function(roomId) {
            try {
                peerConnection = createPeerConnection();
                
                // Setup remote video
                screenShare.innerHTML = '<video autoplay playsinline></video>';
                const video = screenShare.querySelector('video');
                
                // When remote stream arrives, show it
                peerConnection.ontrack = event => {
                    video.srcObject = event.streams[0];
                };
                
                // Handle ICE candidates
                peerConnection.onicecandidate = event => {
                    if (event.candidate) {
                        // Normally you'd send this to signaling server
                        console.log('New ICE Candidate:', event.candidate);
                    }
                };
                
                // Create offer
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                // Here you would normally send the offer via signaling server
                console.log('Created offer:', offer);
                
            } catch (err) {
                console.error('Connection error:', err);
            }
        };

        let peerConnection = null;
        let localStream = null;
        const connectedUsers = [];
        
        function createPeerConnection() {
            const pc = new RTCPeerConnection({
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' }
                ]
            });
            
            if (localStream) {
                localStream.getTracks().forEach(track => 
                    pc.addTrack(track, localStream)
                );
            }
            
            return pc;
        }
        
        // Main share function that handles both screen and audio
        shareBtn.addEventListener('click', async () => {
            try {
                // Yêu cầu quyền chia sẻ màn hình
                // Check if we want screen sharing or audio sharing
                const shareType = event.target.id === 'shareScreenBtn' ? 'screen' : 'audio';
                
                if (shareType === 'screen') {
                    const constraints = {
                        video: { 
                            displaySurface: 'browser',
                            width: { ideal: 1280 },
                            height: { ideal: 720 } 
                        },
                        audio: true
                    };
                    localStream = await navigator.mediaDevices.getDisplayMedia(constraints);
                } else {
                    localStream = await navigator.mediaDevices.getUserMedia({ 
                        audio: true,
                        video: false
                    });
                }

                const videoElement = document.createElement('video');
                videoElement.srcObject = localStream;
                videoElement.autoplay = true;
                videoElement.playsInline = true;
                
                // Trên thực tế bạn cần gửi stream này đến server
                document.getElementById('shareScreenBtn').disabled = true;
                document.getElementById('shareAudioBtn').disabled = true;
                stopShareBtn.disabled = false;
                
                // Thêm vào danh sách người chia sẻ
                updateActiveUsers();
                
                const roomCode = Math.floor(Math.random()*90000) + 10000;
                alert(`Đang chia sẻ màn hình\nMã phòng: ${roomCode}\nChia sẻ mã này với đồng đội`);
                navigator.clipboard.writeText(roomCode.toString());
            } catch (err) {
                console.error('Lỗi khi chia sẻ màn hình:', err);
                alert('Không thể chia sẻ màn hình: ' + err.message);
            }
        });

        // Dừng chia sẻ màn hình
        stopShareBtn.addEventListener('click', () => {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
                
                document.getElementById('shareScreenBtn').disabled = false;
                document.getElementById('shareAudioBtn').disabled = false;
                stopShareBtn.disabled = true;
                
                alert('Đã dừng chia sẻ màn hình');
            }
        });

        // Kết nối đến phòng chia sẻ
        connectBtn.addEventListener('click', () => {
            if (!roomId.value.trim()) {
                alert('Vui lòng nhập ID phòng');
                return;
            }
            
            // Trong ứng dụng thực tế, bạn sẽ kết nối với signaling server
            connectToStream(roomId.value);
        });

        // Load danh sách người chơi khi trang tải
        updateActiveUsers();
    </script>
</body>
</html>
